<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart.js Y轴测试</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .chart-container {
            width: 800px;
            height: 400px;
            margin: 20px 0;
        }
        .info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Chart.js Y轴范围测试</h1>
    
    <div class="info">
        <strong>测试目的：</strong>验证Chart.js是否正确应用手动设置的Y轴min/max值<br>
        <strong>测试数据：</strong>值在56.15到68.35之间<br>
        <strong>期望结果：</strong>Y轴显示范围应该严格控制在计算的边界内
    </div>
    
    <div class="chart-container">
        <canvas id="testChart"></canvas>
    </div>
    
    <div class="info">
        <button onclick="updateChart()">更新图表（模拟数据变化）</button>
        <button onclick="logChartInfo()">显示图表信息</button>
    </div>
    
    <div id="info-display"></div>

    <script>
        let testChart;
        
        // 测试数据 - 模拟电量数据
        const testData = [
            { time: '00:00', value: 68.35 },
            { time: '01:00', value: 67.80 },
            { time: '02:00', value: 67.25 },
            { time: '03:00', value: 66.70 },
            { time: '04:00', value: 66.15 },
            { time: '05:00', value: 65.60 },
            { time: '06:00', value: 65.05 },
            { time: '07:00', value: 64.50 },
            { time: '08:00', value: 63.95 },
            { time: '09:00', value: 63.40 },
            { time: '10:00', value: 62.85 },
            { time: '11:00', value: 62.30 },
            { time: '12:00', value: 61.75 },
            { time: '13:00', value: 61.20 },
            { time: '14:00', value: 60.65 },
            { time: '15:00', value: 60.10 },
            { time: '16:00', value: 59.55 },
            { time: '17:00', value: 59.00 },
            { time: '18:00', value: 58.45 },
            { time: '19:00', value: 57.90 },
            { time: '20:00', value: 57.35 },
            { time: '21:00', value: 56.80 },
            { time: '22:00', value: 56.25 },
            { time: '23:00', value: 56.15 }
        ];
        
        function calculateYAxisBounds(values) {
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const padding = (maxValue - minValue) * 0.02; // 2%的边距
            
            let finalMin = minValue - padding;
            let finalMax = maxValue + padding;
            
            // 对齐到0或5结尾
            finalMin = Math.floor(finalMin * 100) / 100;
            finalMax = Math.ceil(finalMax * 100) / 100;
            
            // 调整到0或5结尾
            const minLastDigit = Math.abs(Math.round(finalMin * 100)) % 10;
            const maxLastDigit = Math.abs(Math.round(finalMax * 100)) % 10;
            
            if (minLastDigit !== 0 && minLastDigit !== 5) {
                if (minLastDigit < 5) {
                    finalMin = Math.floor(finalMin * 10) / 10;
                } else {
                    finalMin = Math.floor(finalMin * 10 - 5) / 10;
                }
            }
            
            if (maxLastDigit !== 0 && maxLastDigit !== 5) {
                if (maxLastDigit <= 5) {
                    finalMax = Math.ceil(finalMax * 10) / 10 + 0.05;
                } else {
                    finalMax = Math.ceil(finalMax * 10) / 10;
                }
            }
            
            return { min: finalMin, max: finalMax };
        }
        
        function initializeChart() {
            const ctx = document.getElementById('testChart');
            const values = testData.map(d => d.value);
            const bounds = calculateYAxisBounds(values);
            
            console.log('计算的Y轴边界：', bounds);
            
            testChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: testData.map(d => d.time),
                    datasets: [{
                        label: '剩余电量 (度)',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: bounds.min,
                            max: bounds.max,
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '剩余电量 (度)'
                            },
                            ticks: {
                                stepSize: 0.1,
                                includeBounds: true,
                                callback: function(value) {
                                    const rounded = Math.round(value * 100) / 100;
                                    const lastDigit = Math.abs(Math.round(rounded * 100)) % 10;
                                    
                                    if (lastDigit === 0 || lastDigit === 5) {
                                        return rounded.toFixed(2);
                                    }
                                    return null;
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            bounds: 'data',
                            grace: 0
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            logChartInfo();
        }
        
        function updateChart() {
            // 模拟数据变化 - 稍微调整值
            const newValues = testData.map(d => ({
                time: d.time,
                value: d.value + (Math.random() - 0.5) * 0.2
            }));
            
            const values = newValues.map(d => d.value);
            const bounds = calculateYAxisBounds(values);
            
            console.log('更新后的Y轴边界：', bounds);
            
            // 更新数据
            testChart.data.datasets[0].data = values;
            
            // 更新Y轴配置
            testChart.options.scales.y.min = bounds.min;
            testChart.options.scales.y.max = bounds.max;
            
            // 强制更新图表
            testChart.update('none');
            
            setTimeout(() => {
                logChartInfo();
            }, 100);
        }
        
        function logChartInfo() {
            const yScale = testChart.scales.y;
            const dataValues = testChart.data.datasets[0].data;
            const minData = Math.min(...dataValues);
            const maxData = Math.max(...dataValues);
            
            const info = `
                <h3>图表状态信息</h3>
                <p><strong>数据范围：</strong> ${minData.toFixed(3)} 到 ${maxData.toFixed(3)}</p>
                <p><strong>配置的Y轴范围：</strong> ${testChart.options.scales.y.min?.toFixed(3) || '未设置'} 到 ${testChart.options.scales.y.max?.toFixed(3) || '未设置'}</p>
                <p><strong>实际Y轴范围：</strong> ${yScale.min?.toFixed(3) || '未知'} 到 ${yScale.max?.toFixed(3) || '未知'}</p>
                <p><strong>Y轴像素高度：</strong> ${yScale.height || '未知'} px</p>
                <p><strong>数据点是否在可视范围内：</strong> ${(minData >= (yScale.min || 0) && maxData <= (yScale.max || 100)) ? '是' : '否'}</p>
            `;
            
            document.getElementById('info-display').innerHTML = info;
            
            console.log('Chart Y Scale Info:', {
                configuredMin: testChart.options.scales.y.min,
                configuredMax: testChart.options.scales.y.max,
                actualMin: yScale.min,
                actualMax: yScale.max,
                dataMin: minData,
                dataMax: maxData
            });
        }
        
        // 初始化图表
        document.addEventListener('DOMContentLoaded', initializeChart);
    </script>
</body>
</html>
